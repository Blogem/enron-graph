# Frontend API Types (TypeScript)

**Package**: `frontend/src/types`  
**File**: `graph.ts`  
**Purpose**: TypeScript type definitions for Wails API bindings

---

## Type Definitions

```typescript
/**
 * Graph Explorer Frontend Types
 * These types match the Go structs in internal/explorer/models.go
 * Auto-generated by Wails, can be extended here for React-specific needs
 */

// ============================================================================
// Core Graph Types
// ============================================================================

/**
 * GraphNode represents an entity in the graph visualization
 */
export interface GraphNode {
  id: string;
  type: string; // e.g., "Email", "Person", "Organization"
  category: "promoted" | "discovered";
  properties: Record<string, any>; // Dynamic properties
  is_ghost: boolean; // True if placeholder for batched loading
  degree?: number; // Total relationship count (optional)
}

/**
 * GraphEdge represents a relationship between two nodes
 */
export interface GraphEdge {
  source: string; // Source node ID
  target: string; // Target node ID  
  type: string; // Relationship type (e.g., "sent_to", "reports_to")
  properties?: Record<string, any>; // Optional edge attributes
}

/**
 * GraphResponse contains a subset of the graph for visualization
 */
export interface GraphResponse {
  nodes: GraphNode[];
  edges: GraphEdge[];
  total_nodes: number;
  has_more: boolean;
}

/**
 * RelationshipsResponse contains paginated relationships for a node
 */
export interface RelationshipsResponse {
  edges: GraphEdge[];
  nodes: GraphNode[]; // Connected nodes being added to graph
  total_count: number; // Total relationships for this node
  has_more: boolean;
  offset: number; // Current pagination offset
}

// ============================================================================
// Schema Types
// ============================================================================

/**
 * PropertyDefinition describes a single property/field
 */
export interface PropertyDefinition {
  name: string;
  data_type: string; // e.g., "string", "int", "timestamp", "jsonb"
  sample_value: any; // Example value (can be null)
  nullable: boolean;
}

/**
 * SchemaType describes an entity type's schema
 */
export interface SchemaType {
  name: string; // e.g., "Email", "Person"
  category: "promoted" | "discovered";
  count: number; // Number of entities of this type
  properties: PropertyDefinition[];
  relationships: string[]; // Relationship type names
}

/**
 * SchemaResponse contains complete schema metadata
 */
export interface SchemaResponse {
  promoted_types: SchemaType[];
  discovered_types: SchemaType[];
  total_entities: number;
}

// ============================================================================
// Filter Types
// ============================================================================

/**
 * NodeFilter specifies criteria for filtering graph nodes
 */
export interface NodeFilter {
  types?: string[]; // Type names to include (empty = all)
  category?: "promoted" | "discovered" | ""; // Empty = all
  search_query?: string; // Property value search
  limit?: number;
}

// ============================================================================
// React-Specific Extended Types
// ============================================================================

/**
 * GraphNodeWithPosition extends GraphNode for react-force-graph
 * The force-graph library adds x, y, z coordinates at runtime
 */
export interface GraphNodeWithPosition extends GraphNode {
  x?: number;
  y?: number;
  z?: number;
  vx?: number; // Velocity for physics simulation
  vy?: number;
  vz?: number;
  fx?: number; // Fixed position (if pinned)
  fy?: number;
  fz?: number;
}

/**
 * GraphEdgeWithSource extends GraphEdge for react-force-graph
 * The force-graph library replaces string IDs with node references
 */
export interface GraphEdgeWithSource extends Omit<GraphEdge, 'source' | 'target'> {
  source: GraphNodeWithPosition | string;
  target: GraphNodeWithPosition | string;
}

/**
 * GraphData is the complete data structure for react-force-graph
 */
export interface GraphData {
  nodes: GraphNodeWithPosition[];
  links: GraphEdgeWithSource[]; // react-force-graph uses 'links' not 'edges'
}

/**
 * ExpandedNodeState tracks which node batches have been loaded
 * Used for "Load more" button state management
 */
export interface ExpandedNodeState {
  [nodeId: string]: {
    loadedOffset: number; // How many relationships loaded so far
    totalCount: number; // Total relationships for this node
    hasMore: boolean;
  };
}

// ============================================================================
// Component Props Types
// ============================================================================

/**
 * Props for GraphCanvas component
 */
export interface GraphCanvasProps {
  data: GraphData;
  onNodeClick: (node: GraphNodeWithPosition) => void;
  onNodeRightClick?: (node: GraphNodeWithPosition) => void;
  onLinkClick?: (edge: GraphEdgeWithSource) => void;
  selectedNodeId?: string | null;
}

/**
 * Props for SchemaPanel component
 */
export interface SchemaPanelProps {
  schema: SchemaResponse;
  onTypeClick: (typeName: string) => void;
  onRefresh: () => void;
  isLoading?: boolean;
}

/**
 * Props for DetailPanel component
 */
export interface DetailPanelProps {
  node: GraphNode | null;
  onClose: () => void;
  onExpand: (nodeId: string) => void;
  expandState?: ExpandedNodeState;
}

/**
 * Props for FilterBar component
 */
export interface FilterBarProps {
  schema: SchemaResponse;
  currentFilter: NodeFilter;
  onFilterChange: (filter: NodeFilter) => void;
}

/**
 * Props for LoadMoreButton component
 */
export interface LoadMoreButtonProps {
  nodeId: string;
  remainingCount: number;
  onLoadMore: () => void;
  isLoading?: boolean;
}

// ============================================================================
// Wails Service Bindings (auto-generated by Wails)
// ============================================================================

/**
 * These functions are generated by Wails from Go methods
 * Import from '../wailsjs/go/explorer/GraphService'
 */
export interface GraphServiceAPI {
  GetRandomNodes(limit: number): Promise<GraphResponse>;
  GetNodes(filter: NodeFilter): Promise<GraphResponse>;
  GetRelationships(nodeId: string, offset: number, limit: number): Promise<RelationshipsResponse>;
  GetNodeDetails(nodeId: string): Promise<GraphNode>;
}

/**
 * These functions are generated by Wails from Go methods
 * Import from '../wailsjs/go/explorer/SchemaService'
 */
export interface SchemaServiceAPI {
  GetSchema(): Promise<SchemaResponse>;
  GetTypeDetails(typeName: string): Promise<SchemaType>;
  RefreshSchema(): Promise<SchemaResponse>;
}

// ============================================================================
// Utility Types
// ============================================================================

/**
 * Color mapping for entity types in visualization
 */
export type NodeColorMap = Record<string, string>;

/**
 * Default color palette for promoted vs discovered entities
 */
export const DEFAULT_COLORS = {
  promoted: {
    Email: '#3b82f6', // blue
    Relationship: '#8b5cf6', // purple
    SchemaPromotion: '#10b981', // green
  },
  discovered: {
    Person: '#f59e0b', // amber
    Organization: '#ef4444', // red
    Location: '#14b8a6', // teal
    Concept: '#ec4899', // pink
    _default: '#6b7280', // gray (for unknown types)
  },
} as const;

/**
 * Node size calculation based on degree
 */
export function getNodeSize(node: GraphNode): number {
  const baseSizesize = 4;
  const maxSize = 20;
  
  if (!node.degree) return baseSize;
  
  // Logarithmic scaling for high-degree nodes
  return Math.min(baseSize + Math.log10(node.degree + 1) * 3, maxSize);
}

/**
 * Get color for a node based on its type and category
 */
export function getNodeColor(node: GraphNode): string {
  if (node.category === 'promoted') {
    return DEFAULT_COLORS.promoted[node.type as keyof typeof DEFAULT_COLORS.promoted] 
      || DEFAULT_COLORS.discovered._default;
  } else {
    return DEFAULT_COLORS.discovered[node.type as keyof typeof DEFAULT_COLORS.discovered] 
      || DEFAULT_COLORS.discovered._default;
  }
}

/**
 * Format property value for display in detail panel
 */
export function formatPropertyValue(value: any): string {
  if (value === null || value === undefined) {
    return '(null)';
  }
  if (typeof value === 'object') {
    return JSON.stringify(value, null, 2);
  }
  if (typeof value === 'boolean') {
    return value ? 'true' : 'false';
  }
  return String(value);
}
```

---

## Usage Examples

### Calling Wails Backend from React

```typescript
import { GetRandomNodes, GetRelationships } from '../wailsjs/go/explorer/GraphService';
import { GetSchema } from '../wailsjs/go/explorer/SchemaService';
import { GraphResponse, SchemaResponse } from '../types/graph';

// Load initial graph
async function loadInitialGraph(): Promise<GraphResponse> {
  const response = await GetRandomNodes(100);
  return response; // Typed as GraphResponse
}

// Load more relationships
async function expandNode(nodeId: string, offset: number): Promise<RelationshipsResponse> {
  const response = await GetRelationships(nodeId, offset, 50);
  return response; // Typed as RelationshipsResponse
}

// Load schema
async function loadSchema(): Promise<SchemaResponse> {
  const response = await GetSchema();
  return response; // Typed as SchemaResponse
}
```

### Converting to react-force-graph format

```typescript
import { GraphResponse, GraphData } from '../types/graph';

function convertToForceGraphData(response: GraphResponse): GraphData {
  return {
    nodes: response.nodes.map(node => ({
      ...node,
      // react-force-graph will add x, y, z coordinates
    })),
    links: response.edges.map(edge => ({
      ...edge,
      // react-force-graph will convert source/target strings to node references
    })),
  };
}
```

### Using in React components

```typescript
import React, { useState, useEffect } from 'react';
import { GraphData, SchemaResponse } from '../types/graph';
import { GetRandomNodes } from '../wailsjs/go/explorer/GraphService';
import { GetSchema } from '../wailsjs/go/explorer/SchemaService';

function App() {
  const [graphData, setGraphData] = useState<GraphData>({ nodes: [], links: [] });
  const [schema, setSchema] = useState<SchemaResponse | null>(null);
  
  useEffect(() => {
    async function loadData() {
      const [graphResp, schemaResp] = await Promise.all([
        GetRandomNodes(100),
        GetSchema(),
      ]);
      
      setGraphData({
        nodes: graphResp.nodes,
        links: graphResp.edges,
      });
      setSchema(schemaResp);
    }
    
    loadData();
  }, []);
  
  // ... render components
}
```

---

## Type Generation

These types should be kept in sync with Go structs using:

```bash
# After modifying Go structs in internal/explorer/models.go
cd frontend
wails generate module

# This updates wailsjs/go/explorer/*.ts with latest types
```

For custom React-specific types (like `GraphNodeWithPosition`), maintain them manually in `types/graph.ts`.
